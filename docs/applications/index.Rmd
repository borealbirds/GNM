---
title: "Applications"
output:
  md_document:
    preserve_yaml: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
    fig.path="applications/index_files/figure-markdown_strict/")
knitr::opts_knit$set(
    base.dir="~/repos/GNM/docs/",
    base.url="https://borealbirds.github.io/GNM/")
```

The BAM National Model results are meant to be used in various applications.
We provide some R scripts here to facilitate the use of the results.

## Prerequisites

We will assume that you use R version >= 3.6 with the following
packages installed: 
[raster](https://CRAN.R-project.org/package=raster), 
[sf](https://CRAN.R-project.org/package=sf), 
[jsonlite](https://CRAN.R-project.org/package=jsonlite),
[readxl](https://CRAN.R-project.org/package=readxl),
[ggplot2](https://CRAN.R-project.org/package=ggplot2).

## Working with the JSON API

The JSON API uses JSON as data exchange format.
Let's define the url for the BAM v4 API:

```{r}
library(jsonlite)
api_root <- "https://borealbirds.github.io/api/v4"
```

### Get the list of species

First, we need to get the list of species from the JSON API,
so that we know what species codes to use:

```{r}
library(jsonlite)
api_root <- "https://borealbirds.github.io/api/v4"
tab <- fromJSON(file.path(api_root, "species"))
str(tab)
head(tab[,c("id", "english")])
```

### Get estimates for a species

We can use the `id` column if we need to loop over multiple species.
Now we'll only use one species, Canada Warbler (`"CAWA"`):

```{r}
spp <- "CAWA"
results <- fromJSON(file.path(api_root, "species", spp))
str(results, max.level=2)
```

The `species` element in the list contain the species info
saw already in the species `tab`le.

The `popsize` element contains population sizes, densities, and areas
for the various regions:

```{r}
(N <- do.call(cbind, results$popsize))
```

```{r results='hide'}
library(ggplot2)
ggplot(N[-1,], aes(x=region, y=abundance.estimate)) +
    geom_bar(stat="identity", fill="#95B6C1") +
    coord_flip() +
    geom_errorbar(aes(ymin=abundance.lower, ymax=abundance.upper), 
                  width=0.2, color="#105A73") +
    ylab("Abundance (M males)") +
    xlab("BCR") +
    theme_minimal()
```


The `densplot` element contains the regional landcover specific densities:

```{r}
## pick a region
results$densplot$region
region <- 1
results$densplot$region[region]

## densities for this region
(D <- as.data.frame(lapply(results$densplot$data, "[[", 1)))
```

```{r results='hide'}
ggplot(D, aes(x=landcover, y=estimate)) +
    geom_bar(stat="identity", fill="#95B6C1") +
    coord_flip() +
    geom_errorbar(aes(ymin=lower, ymax=upper), 
                  width=0.2, color="#105A73") +
    ylab("Density (males/ha)") +
    xlab("Landcover") +
    theme_minimal()
```

These results reflect population  and density
as males only (million males, males/ha, respectively).
To apply a pair adjustment, the numbers have to be multiplied by 2.

### Density map images

The density map images can be accessed as
`https://borealbirds.github.io/api/v4/species/CAWA/images/mean-pred.png`
and 
`https://borealbirds.github.io/api/v4/species/CAWA/images/mean-det.png`.

![](https://borealbirds.github.io/api/v4/species/CAWA/images/mean-pred.png)

![](https://borealbirds.github.io/api/v4/species/CAWA/images/mean-det.png)

## Assessing results

Accessing the `BAMv4-results-2020-02-20.xlsx` file gives us the following
tables (sheet names in parenthesis):

- metadata explaining sheets and columns (metadata)
- list species of species (species)
- list of variables (variables)
- variable importance (importance)
- model validation results (validation)
- population estimates (abundances)
- lend cover based density estimates (densities)

Download the Excel file in a temporary file:

```{r}
library(readxl)
tmp <- tempfile()
download.file(file.path(api_root, "BAMv4-results-2020-02-20.xlsx"), tmp)
```

Now we can read in different sheets:

```{r}
vars <- read_xlsx(tmp, sheet="variables")
str(vars)
```

Let's read in all the tables and delete the temp file:

```{r}
sheets <- c(
    "metadata",
    "species",
    "variables",
    "importance",
    "validation",
    "abundances",
    "densities")
tabs <- list()
for (sheet in sheets)
    tabs[[sheet]] <- read_xlsx(tmp, sheet)
unlink(tmp)
```

Here are variable importance results:


```{r fig.width=8,fig.height=8}
i <- tabs$importance
i <- i[i$id == spp & i$region != "Canada",]
i$BCR <- sapply(strsplit(i$region, " "), "[[", 1)
ii <- stats::xtabs(importance ~ variable + BCR, i)
heatmap(ii, margins = c(5, 10), col=hcl.colors(100, "Teal", rev=TRUE))
```


These are validation results for the Canada Warbler:

```{r}
v <- tabs$validation
v <- v[v$id == spp,]
v[order(v$prevalence, decreasing=TRUE), c(4,5,8:12)]
```

AUC was used to assess classification accuracy and pseudo R<sup>2</sup> to quantify the proportion of variance explained. OCCC measures correspondence across bootstrap based predictions. OCCC is the product of two the overall precision (how far each observation deviated from the best fit line), and the overall accuracy (how far the best line deviates from the 1:1 line).

